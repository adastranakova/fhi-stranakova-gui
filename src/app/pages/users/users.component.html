<div class="container">
  <app-page-title title="Users"></app-page-title>

  <app-card>
    @if (loading()) {
      <app-loader></app-loader>
    } @else {
      @if (users().length === 0) {
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> No users found
        </div>
      } @else {
        <table class="table table-hover">
          <thead>
          <tr>
            <th>Member ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Balance</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody>
            @for (user of users(); track user.memberId) {
              <tr>
                <td>{{ user.memberId }}</td>
                <td>{{ user.name }}</td>
                <td>{{ user.email }}</td>
                <td>${{ (+user.balance).toFixed(2) }}</td>
                <td>
                  <button class="btn btn-sm btn-warning me-1" (click)="openEditModal(user)">
                    <i class="bi bi-pencil"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-success me-1" (click)="addFunds(user.memberId)">
                    <i class="bi bi-cash"></i> Add Funds
                  </button>
                  <button class="btn btn-sm btn-info me-1" (click)="deductFunds(user.memberId)">
                    <i class="bi bi-dash-circle"></i> Deduct Funds
                  </button>
                  <button class="btn btn-sm btn-danger" (click)="deleteUser(user.memberId)">
                    <i class="bi bi-trash"></i> Delete
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      }

      <div class="row justify-content-end mt-3">
        <div class="col-auto">
          <button class="btn btn-primary" routerLink="/users/create">
            <i class="bi bi-plus"></i> Add User
          </button>
        </div>
      </div>
    }
  </app-card>
</div>

<!-- Edit User Modal -->
@if (showEditModal()) {
  <div class="modal" style="display: block; background: rgba(0,0,0,0.5);" (click)="closeEditModal()">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit User</h5>
          <button type="button" class="btn-close" (click)="closeEditModal()"></button>
        </div>
        <div class="modal-body">
          @if (editError()) {
            <div class="alert alert-danger">
              {{ editError() }}
            </div>
          }

          <div class="mb-3">
            <label class="form-label">Member ID</label>
            <input
              type="text"
              class="form-control"
              [value]="editingUser()?.memberId"
              disabled>
          </div>

          <div class="mb-3">
            <label class="form-label">Name *</label>
            <input
              type="text"
              class="form-control"
              [value]="editName()"
              (input)="editName.set($any($event.target).value)"
              placeholder="Enter name">
          </div>

          <div class="mb-3">
            <label class="form-label">Email *</label>
            <input
              type="email"
              class="form-control"
              [value]="editEmail()"
              (input)="editEmail.set($any($event.target).value)"
              placeholder="Enter email">
          </div>

          <div class="mb-3">
            <label class="form-label">Balance</label>
            <input
              type="text"
              class="form-control"
              [value]="'$' + (+(editingUser()?.balance ?? 0)).toFixed(2)"
              disabled>
            <small class="text-muted">Use "Add Funds" button to modify balance</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeEditModal()">
            Cancel
          </button>
          <button
            type="button"
            class="btn btn-primary"
            (click)="updateUser()"
            [disabled]="updating()">
            @if (updating()) {
              <span class="spinner-border spinner-border-sm me-1"></span>
            }
            Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>
}
